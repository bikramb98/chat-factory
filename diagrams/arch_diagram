graph TD;
    User["ðŸ‘¤ User"] -->|Submits query| APIGateway["ðŸ›¡ï¸ API Gateway"];
    
    subgraph "Orchestration Layer"
        APIGateway --> RequestRouter["ðŸ”€ Request Router"];
    end

    subgraph "LLM Service"
        QueryClassifier["ðŸ¤– Query Classifier (LLM Call #1)"];
        SQLQueryGen["ðŸ“ SQL Query Generator (LLM Call #2)"];
        SQLResponseFormatter["ðŸ“ SQL Response Formatter (LLM Call #3)"];
        RAGAnswerGen["ðŸ“š RAG Answer Generator (LLM Call #2)"];
    end

    subgraph "Database"
        SQLDatabase["ðŸ—„ï¸ SQL Database"];
    end

    subgraph "Document Processing"
        PDFMonitor["ðŸ“¡ PDF Change Detector"];
        PDFProcessor["ðŸ“„ PDF Processor"];
        TextChunking["ðŸ” Text Chunking & Embedding"];
        VectorSearch["ðŸ—‚ï¸ Vector Search (FAISS)"];
    end

    APIGateway -->|Classify 'SQL' or 'RAG'| QueryClassifier;
    QueryClassifier --> RequestRouter;

    RequestRouter -- If SQL --> SQLQueryGen;
    SQLQueryGen -->|Run Query| SQLDatabase;
    SQLDatabase --> SQLResponseFormatter;
    SQLResponseFormatter -->|Return Response| APIGateway;

    RequestRouter -- If RAG --> VectorSearch;
    VectorSearch --> RAGAnswerGen;
    RAGAnswerGen -->|Return Response| APIGateway;

    %% Ensure PDF processing happens only on changes
    PDFMonitor -- If new or modified PDF --> PDFProcessor;
    PDFProcessor --> TextChunking;
    TextChunking --> VectorSearch;
    
    APIGateway -->|Shows Response| User;